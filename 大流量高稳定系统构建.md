# 大流量高稳定系统构建

## 1 核心解决问题

+ 性能
+ 容量
+ 扩展性
+ 可靠性
+ 监控

## 2 经验参考

+ 优先解决用户的迫切需求
+ 平衡短期需求和长期需求
+ 架构设计不能向问题妥协

## 3 设计的十大原则

1. 按业务切分系统
2. 灾备切换
3. 水平扩展-分流（上策）
4. 超预期流量-限流（中策）
5. 保护系统-降级（下策）
6. 提高性能-读写分离
7. 唯快不破-异步化
8. 动态静态流量分类
9. 线上压力测试-发现瓶颈
10. 预案

### 3.1 按业务切分系统

+ 网站系统：首页，列表，频道，单品，搜索

+ 交易系统：价格，购物车，结算，支付，订单中心

+ 基础服务：促销，库存，商品，用户

+ 订单系统：管道，OFW，订单中间件，生产系统

### 3.2 灾备切换原则

#### 3.2.1 多机房部署

+ 应用场景：机房内部出现大面积故障和机房入口流量故障

+ 入口切换策略：

1. DNS域名：特点是切换比较慢，具有地域性，用于解决机房入口问题 + 机房内部问题
2. LVS + HAProxy 直接路由：特点是切换比较快（可以实现秒级切换），用于解决机房内部大面积故障

#### 3.2.2 机房内部切换
+ 调用者客户端切换：

1. Java应用切换策略： 底层服务框架，VIP, 内部DNS
2. 缓存策略切换（如redis）
3. 数据库切换策略：客户端，DB本身
#### 3.2.3 数据一致性保证
+ 灾备实现方法

1. 程序双写
特点：灵活，集群间相互切换快
分类：
a. 同步双写：数据一致性要求比较高，影响性能，不适合多个集群
b. 异步双写：数据一致性差，性能高，适合多个集群
2. 底层存储数据复制
优点： 数据一致性高（库存系统等重要数据需要）
缺点：主从切换不灵活，复制节点出问题后，恢复慢

#### 3.2.4 灾备集群

+ 灾备集群分类
1. 空闲灾备集群
存在问题：管理成本 热点缓存无法瞬间复制 
2. 小流量灾备集群
存在问题：增加事故风险（因为增加了） 管理成本
3. 全部切换， 部分切换

### 3.3 限流原则

#### 3.3.1 区分正常流量和超预期流量
超预期流量：恶意， 秒杀等
#### 3.3.2 限流策略
1. Nginx层限流策略
a. 自主研发模块 
b. 限流规则：账户，IP,系统调用逻辑
2. WEB应用限流
3. 业务应用限流（影响用户体验 不推荐）
a. 读少限 写多限
b. 限流标准来自压力测试 交易-库存
4. DB限流

### 3.4 分流原则
#### 3.4.1 水平扩展
无状态应用简单 有状态应用困难
#### 3.4.2 系统峰值引流
1. 数据完全独立部署 特点热点数据少 如秒杀商品
2. 应用独立部署
3. 定制化策略
#### 3.4.3 非重要业务分流到单独集群
+ 购物车的库存状态，地址
+ 结算页的运险费 promise标志

### 3.5 读写分离原则
#### 3.5.1 整体系统的读写分离
#### 3.5.2 读性能提升
1. 内存
2. 远程
3. 热点100万单
#### 3.5.3 写性能提升
1. 异步化 (管道服务读写DB)
2. 数据分片 (REDIS, DB)

### 3.6 降级原则

万不得已而为之。
#### 3.6.1 系统级降级
#### 3.6.2 业务功能模块降级
1. 业务逻辑
实时价格更新不及时
2. 页面降级
我的京东首页 动态降级到静态
3. 非关键业务屏蔽
购物车缓存状态
4. 远程服务降级到本地缓存
运费

### 3.7 动静分离原则

#### 3.7.1 静态流量
1. CDN
2. 单独部署
#### 3.7.2 动态流量

### 3.8 异步化原则
#### 3.8.1 页面异步化
购物车 结算页
#### 3.8.2 写逻辑异步化
促销 存储

### 3.9 线上压测原则
#### 3.9.1 读逻辑
#### 3.9.2 写逻辑
要小心
#### 3.9.3 覆盖范围

#### 3.9.2 性能指标
+ 硬件： CPU 内存 硬盘 网络
+ 软件：吞吐量 并发数 服务响应时长
#### 3.9.2 工具
+ tcpcopy 测读 真实
+ 压测工具 测写 可控
+ 恶意流量 利用恶意流量可做压测

### 3.10 管理-预案
#### 3.10.1 预案准备
#### 3.10.2 预案执行
1. 发现问题
通过软件 硬件 人眼监控
2. 定位问题
监控数据 日志
3. 解决问题
#### 3.10.3 预案演练
1. 线上演练
2. 压力测试
3. 平时积累